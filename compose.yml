version: "3.8"
services:
  reverse-proxy:
    image: traefik:v2.10
    command: --api.insecure=true --providers.docker
    ports:
      - 8080:80
      - 8081:8080
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
  database:
    image: "bitnami/postgresql:13"
    env_file:
      - .env
  backend:
    image: garage/back-end
    build:
      context: ./garage-backend
      dockerfile: ./Dockerfile
    env_file:
      - .env
    labels:
      - "traefik.http.routers.backend.rule=Host(`api.localhost`)"
      - "traefik.http.services.backend-service.loadBalancer.sticky.cookie=true"
      - "traefik.http.services.backend-service.loadBalancer.sticky.cookie.name=api_session"
  frontend:
    container_name: garage-front-end
    image: garage/front-end
    build:
      context: ./garage-frontend
      dockerfile: ./Dockerfile
    labels:
      - "traefik.http.routers.frontend.rule=Host(`localhost`)"
